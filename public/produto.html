<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Detalhe do Produto</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#fffaf5; color:#222; }
header { background:#651616; color:#fff; padding:12px 20px; display:flex; align-items:center; }
header a { color:#fff; text-decoration:none; margin-left:20px; font-weight:600; }
.container { max-width:900px; margin:100px auto 50px; padding:16px; display:flex; gap:24px; flex-wrap:wrap; }
.produto-img { flex:1; min-width:280px; }
.produto-img img { width:100%; border-radius:12px; object-fit:cover; }
.produto-info { flex:1; min-width:280px; display:flex; flex-direction:column; gap:12px; }
.produto-info h2 { color:#651616; margin:0; }
.produto-info p { color:#555; }
.produto-info .preco { color:#f5c144; font-weight:700; font-size:1.3rem; }
.produto-info .quantidade-box { display:flex; gap:6px; align-items:center; margin-top:6px; }
.produto-info .quantidade-box button { width:28px; height:28px; border:none; border-radius:6px; background:#651616; color:#fff; font-weight:700; cursor:pointer; }
.produto-info .quantidade-box input { width:50px; text-align:center; border-radius:6px; border:1px solid #ccc; padding:4px; }
.produto-info button.add-btn { margin-top:12px; padding:12px; border-radius:8px; border:none; background:#651616; color:#fff; font-weight:700; cursor:pointer; }
.produto-info button.add-btn:hover { background:#f5c144; color:#651616; }
</style>
</head>
<body>
<header>
  <div>ChupChup <span style="color:#f5c144">CremosÃ£o</span></div>
  <a href="index.html">Voltar</a>
</header>

<div class="container">
  <div class="produto-img">
    <img id="imgProduto" src="" alt="Produto">
  </div>
  <div class="produto-info">
    <h2 id="nomeProduto"></h2>
    <p id="descricaoProduto"></p>
    <div class="preco" id="precoProduto"></div>
    <div class="quantidade-box">
      <button id="menosBtn">-</button>
      <input type="number" id="qtdProduto" value="1" min="1">
      <button id="maisBtn">+</button>
    </div>
    <button class="add-btn" id="adicionarProduto">Adicionar ao carrinho</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const lista = document.getElementById("listaProdutos") || (() => {
    const div = document.createElement("div");
    div.id = "listaProdutos";
    document.querySelector("main").appendChild(div);
    return div;
  })();
  const contadorCarrinho = document.getElementById("contador-carrinho");
  const carrinhoFixo = document.getElementById("carrinho-fixo");
  const totalCarrinhoSpan = document.getElementById("totalCarrinho");
  const itensCarrinhoDrawer = document.getElementById("itensCarrinhoDrawer");
  const resumoDrawer = document.getElementById("resumoDrawer");
  const carrinhoDrawer = document.getElementById("carrinho-drawer");
  const popupFinalizar = document.getElementById("finalizar-popup");
  const campoTroco = document.getElementById("campo-troco");
  const selPagamento = document.getElementById("sel-pagamento");
  const perfilPopup = document.getElementById("perfil-popup");

  const nomePerfilInput = document.getElementById("nomePerfilInput");
  const bairroPerfilInput = document.getElementById("bairroPerfilInput");
  const enderecoPerfilInput = document.getElementById("enderecoPerfilInput");
  const referenciaPerfilInput = document.getElementById("referenciaPerfilInput");

  let produtos = [];
  let carrinho = [];

  async function carregarProdutos() {
    lista.innerHTML = "<p>Carregando produtos...</p>";
    try {
      const res = await fetch("https://chupchupcremosao/api/produtos");
      produtos = await res.json();

      if(produtos.length === 0){
        lista.innerHTML = "<p>NÃ£o hÃ¡ produtos disponÃ­veis.</p>";
        return;
      }

      lista.innerHTML = "";
      produtos.forEach(p => {
        const el = document.createElement("div");
        el.className = "produto";
        const imagemUrl = p.imagem.startsWith("http") ? p.imagem : `https://chupchupcremosao${p.imagem}`;
        el.innerHTML = `
          <img src="${imagemUrl}" alt="${p.nome}">
          <h3>${p.nome}</h3>
          <p>${p.descricao || ""}</p>
          <div class="preco">R$ ${parseFloat(p.preco).toFixed(2)}</div>
          <div class="quantidade-box">
            <button onclick="menos(${p.id})">-</button>
            <input type="number" id="qtd-${p.id}" value="1" min="1">
            <button onclick="mais(${p.id})">+</button>
          </div>
          <button class="add-btn" onclick="adicionarCarrinho(${p.id})">Adicionar</button>
        `;
        lista.appendChild(el);
      });
    } catch(e) {
      console.error("Erro ao carregar produtos:", e);
      lista.innerHTML = "<p>NÃ£o foi possÃ­vel carregar os produtos ðŸ˜¢</p>";
    }
  }

  window.mais = (id) => {
    const input = document.getElementById(`qtd-${id}`);
    input.value = parseInt(input.value) + 1;
  };

  window.menos = (id) => {
    const input = document.getElementById(`qtd-${id}`);
    input.value = Math.max(1, parseInt(input.value) - 1);
  };

  window.adicionarCarrinho = (id) => {
    const produto = produtos.find(p => p.id === id);
    const qtd = parseInt(document.getElementById(`qtd-${id}`).value);
    const existente = carrinho.find(i => i.id === id);
    if (existente) existente.qtd += qtd;
    else carrinho.push({ ...produto, qtd });
    atualizarCarrinho();
  };

  window.removerCarrinho = (id) => {
    carrinho = carrinho.filter(i => i.id !== id);
    atualizarCarrinho();
  };

  function atualizarCarrinho() {
    const total = carrinho.reduce((s, p) => s + p.preco * p.qtd, 0);
    const qtdTotal = carrinho.reduce((s, p) => s + p.qtd, 0);

    contadorCarrinho.textContent = qtdTotal;
    totalCarrinhoSpan.textContent = total.toFixed(2);
    carrinhoFixo.style.display = qtdTotal > 0 ? "flex" : "none";

    itensCarrinhoDrawer.innerHTML = carrinho.map(p => `
      <p>
        ${p.qtd}x ${p.nome} â€” R$ ${(p.qtd * p.preco).toFixed(2)}
        <button style="margin-left:8px;background:#f5c144;border:none;padding:4px 8px;border-radius:6px;cursor:pointer"
          onclick="removerCarrinho(${p.id})">Remover</button>
      </p>
    `).join("");

    resumoDrawer.innerHTML = `<b>Total:</b> R$ ${total.toFixed(2)}`;
  }

  const usuario = JSON.parse(localStorage.getItem("usuario")) || {};
  nomePerfilInput.value = usuario.nome || "";
  bairroPerfilInput.value = usuario.bairro || "";
  enderecoPerfilInput.value = usuario.rua || "";
  referenciaPerfilInput.value = usuario.referencia || "";

  window.abrirPerfil = () => { perfilPopup.style.display = "flex"; };
  window.fecharPerfil = () => { perfilPopup.style.display = "none"; };

  document.getElementById("salvarPerfil").onclick = () => {
    usuario.nome = nomePerfilInput.value;
    usuario.bairro = bairroPerfilInput.value;
    usuario.rua = enderecoPerfilInput.value;
    usuario.referencia = referenciaPerfilInput.value;
    localStorage.setItem("usuario", JSON.stringify(usuario));
    alert("Perfil salvo!");
    fecharPerfil();
  };

  document.getElementById("abrir-carrinho").onclick = () => carrinhoDrawer.classList.add("ativo");
  document.getElementById("fechar-carrinho").onclick = () => carrinhoDrawer.classList.remove("ativo");
  document.getElementById("abrir-finalizar").onclick = () => abrirFinalizar();

  selPagamento.addEventListener("change", () => {
    campoTroco.style.display = selPagamento.value === "dinheiro" ? "block" : "none";
  });

  function abrirFinalizar() {
    if (carrinho.length === 0) {
      alert("Seu carrinho estÃ¡ vazio!");
      return;
    }
    popupFinalizar.style.display = "flex";
  }

  document.getElementById("btn-cancelar-popup").onclick = () => popupFinalizar.style.display = "none";

  document.getElementById("btn-confirmar-popup").onclick = () => {
    const tipoEntrega = document.querySelector("input[name='tipoEntrega']:checked").value;
    const pagamento = selPagamento.value;
    const troco = document.getElementById("input-troco").value;

    const qtdTotal = carrinho.reduce((s, p) => s + p.qtd, 0);
    if (qtdTotal < 3 && tipoEntrega === "entrega") {
      alert("Pedido mÃ­nimo para entrega Ã© de 3 chupchups!");
      return;
    }

    let taxaEntrega = tipoEntrega === "entrega" ? 2 : 0;
    const total = carrinho.reduce((s, p) => s + p.preco * p.qtd, 0) + taxaEntrega;

    let msg = `ðŸ§ Pedido ChupChup CremosÃ£o da Barra ðŸ§%0A`;
    msg += `ðŸ‘¤ Nome: ${usuario.nome || '-'}%0AðŸ  EndereÃ§o: ${usuario.rua || '-'}, ${usuario.bairro || '-'}%0AðŸ“ Ref: ${usuario.referencia || '-'}%0A%0A`;
    carrinho.forEach(p => { msg += `${p.qtd}x ${p.nome} â€” R$ ${(p.qtd*p.preco).toFixed(2)}%0A`; });
    msg += `%0AðŸ’° Total: R$ ${total.toFixed(2)}%0AðŸšš Tipo: ${tipoEntrega}%0AðŸ’µ Pagamento: ${pagamento}%0A`;
    if(pagamento==="dinheiro" && troco) msg += `Troco para: R$ ${parseFloat(troco).toFixed(2)}%0A`;

    const numero = "5527997765557";
    const link = `https://api.whatsapp.com/send?phone=${numero}&text=${msg}`;
    window.open(link, "_blank");
    popupFinalizar.style.display = "none";
  };

  carregarProdutos();
});
</script>

</body>
</html>
